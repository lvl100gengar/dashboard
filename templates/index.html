{% extends "base.html" %}

{% block title %}Dashboard - {{ super() }}{% endblock %}

{% block head_extra %}
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
{% endblock %}

{% block content %}
<div class="header-controls">
    <div class="header-left">
        <h1><i class="fas fa-tachometer-alt"></i> Transaction Dashboard</h1>
    </div>
    <div class="header-right">
        <div class="dashboard-controls">
            <div class="control-item">
                <label for="time_window">Time Window</label>
                <select name="time_window" id="time_window" class="control-select">
                    <option value="10" {% if time_window == 10 %}selected{% endif %}>Last 10 Min</option>
                    <option value="30" {% if time_window == 30 %}selected{% endif %}>Last 30 Min</option>
                    <option value="60" {% if time_window == 60 %}selected{% endif %}>Last 60 Min</option>
                </select>
            </div>
            
            <div class="control-item">
                <label for="refresh_rate">Auto-Refresh</label>
                <select name="refresh_rate" id="refresh_rate" class="control-select">
                    <option value="0">Off</option>
                    <option value="1">1s</option>
                    <option value="3" {% if not request.args.get('refresh_rate') or request.args.get('refresh_rate') == '3' %}selected{% endif %}>3s</option>
                    <option value="5">5s</option>
                    <option value="10">10s</option>
                </select>
            </div>
            
            <button type="button" id="generateReportBtn" class="control-btn"><i class="fas fa-chart-bar"></i> Generate Report</button>
        </div>
    </div>
</div>

<div class="dashboard-content">
    <div class="stats-section">
        <h2><i class="fas fa-chart-line"></i> Dashboard Statistics (Last {{ time_window }} minutes)</h2>
        <div class="unified-stats-container" id="statsContainer">
            <div class="stat-card">
                <div class="stat-grid">
                    <!-- Ingress Stats -->
                    <div class="stat-group">
                        <h4><i class="fas fa-arrow-circle-down"></i> Ingress</h4>
                        <div class="stat-item">
                            <strong>BAD_REQUEST</strong>
                            <span class="stat-value" id="bad-request-count">-</span>
                        </div>
                        <div class="stat-item">
                            <strong>CD_UNAVAILABLE</strong>
                            <span class="stat-value" id="cd-unavailable-count">-</span>
                        </div>
                        <div class="stat-item">
                            <strong>SUBMITTED</strong>
                            <span class="stat-value" id="submitted-count">-</span>
                        </div>
                        <div class="stat-item">
                            <strong>Transactions/sec</strong>
                            <span class="stat-value" id="ingress-tx-rate">-</span>
                        </div>
                    </div>
                    
                    <!-- Egress Stats -->
                    <div class="stat-group">
                        <h4><i class="fas fa-arrow-circle-up"></i> Egress</h4>
                        <div class="stat-item">
                            <strong>COMPLETE</strong>
                            <span class="stat-value" id="complete-count">-</span>
                        </div>
                        <div class="stat-item">
                            <strong>EP_UNAVAILABLE</strong>
                            <span class="stat-value" id="ep-unavailable-count">-</span>
                        </div>
                        <div class="stat-item">
                            <strong>Data Rate</strong>
                            <span class="stat-value" id="data-rate">- Mbps</span>
                        </div>
                        <div class="stat-item">
                            <strong>Transactions/sec</strong>
                            <span class="stat-value" id="egress-tx-rate">-</span>
                        </div>
                    </div>
                    
                    <!-- Transit Time Stats -->
                    <div class="stat-group">
                        <h4><i class="fas fa-clock"></i> Transit Time</h4>
                        <div class="stat-item">
                            <strong>Average</strong>
                            <span class="stat-value" id="avg-transit-time">-</span>
                        </div>
                        <div class="stat-item">
                            <strong>Maximum</strong>
                            <span class="stat-value" id="max-transit-time">-</span>
                        </div>
                        <div class="stat-item">
                            <strong>P95</strong>
                            <span class="stat-value" id="p95-transit-time">-</span>
                        </div>
                        <div class="stat-item">
                            <strong>P99</strong>
                            <span class="stat-value" id="p99-transit-time">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="transactions-section">
        <div class="section-header">
            <h2><i class="fas fa-history"></i> Recent Transactions</h2>
            <div class="table-controls">
                <div class="control-group">
                    <label for="filter_username">Username:</label>
                    <select id="filter_username" name="filter_username">
                        <option value="">All Usernames</option>
                        <!-- Username options will be loaded via API -->
                    </select>
                </div>
                <div class="control-group">
                    <label for="filter_status">Status:</label>
                    <select id="filter_status" name="filter_status">
                        <option value="">All Statuses</option>
                        <option value="BAD_REQUEST">BAD_REQUEST</option>
                        <option value="SUBMITTED">SUBMITTED</option>
                        <option value="COMPLETE">COMPLETE</option>
                        <option value="TIMEOUT">TIMEOUT</option>
                        <option value="EP_UNAVAILABLE">EP_UNAVAILABLE</option>
                        <option value="CD_UNAVAILABLE">CD_UNAVAILABLE</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="num_items">Items:</label>
                    <select name="num_items" id="num_items">
                        <option value="50" {% if num_items == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if num_items == 100 %}selected{% endif %}>100</option>
                        <option value="200" {% if num_items == 200 %}selected{% endif %}>200</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="tableContainer">
            <div class="loading-indicator">
                <i class="fas fa-info-circle"></i> Loading transaction data...
            </div>
        </div>
    </div>
</div>

<!-- Reports Modal -->
<div id="reportsModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h2><i class="fas fa-chart-bar"></i> Generate Transaction Report</h2>
            <button class="modal-close" id="closeReportsModal"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <form id="reportForm" method="POST" action="{{ url_for('download_report') }}" class="report-form">
                <div class="form-group">
                    <label for="daterange"><i class="fas fa-calendar-alt"></i> Date Range:</label>
                    <input type="text" name="daterange" id="daterange" class="form-control" />
                </div>
                <div class="form-group">
                    <label for="username"><i class="fas fa-user"></i> Username:</label>
                    <select name="username" id="report_username" class="form-control">
                        <option value="all">All Users</option>
                        <!-- Options will be populated via JavaScript -->
                    </select>
                </div>
                <input type="hidden" name="report_format" id="report_format" value="csv">
            </form>
        </div>
        <div class="modal-footer">
            <button id="downloadCsvBtn" class="btn btn-primary"><i class="fas fa-file-csv"></i> Download CSV</button>
            <button id="downloadHtmlBtn" class="btn btn-primary"><i class="fas fa-file-code"></i> Download HTML</button>
            <button id="cancelReportBtn" class="btn"><i class="fas fa-times"></i> Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script>
    let refreshTimer;
    let lastRefreshTimestamp = new Date().getTime();
    let isRefreshing = false;

    function updateStats(stats) {
        // Update Ingress Stats
        document.getElementById('bad-request-count').textContent = stats.ingress.BAD_REQUEST;
        document.getElementById('cd-unavailable-count').textContent = stats.ingress.CD_UNAVAILABLE;
        document.getElementById('submitted-count').textContent = stats.ingress.SUBMITTED;
        document.getElementById('ingress-tx-rate').textContent = stats.ingress.tx_per_sec;
        
        // Update Egress Stats
        document.getElementById('complete-count').textContent = stats.egress.COMPLETE;
        document.getElementById('ep-unavailable-count').textContent = stats.egress.EP_UNAVAILABLE;
        document.getElementById('data-rate').textContent = `${stats.egress.data_rate_mbps} Mbps`;
        document.getElementById('egress-tx-rate').textContent = stats.egress.tx_per_sec;
        
        // Update Transit Time Stats
        document.getElementById('avg-transit-time').textContent = stats.egress.avg_transit_time || '-';
        document.getElementById('max-transit-time').textContent = stats.egress.max_transit_time || '-';
        document.getElementById('p95-transit-time').textContent = stats.egress.p95_transit_time || '-';
        document.getElementById('p99-transit-time').textContent = stats.egress.p99_transit_time || '-';
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' Bytes';
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        else if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
        else return (bytes / 1073741824).toFixed(1) + ' GB';
    }

    function updateTransactionTable(transactions) {
        const tableContainer = document.getElementById('tableContainer');
        
        if (transactions.length === 0) {
            tableContainer.innerHTML = `
                <div class="no-data-message">
                    <i class="fas fa-info-circle"></i> No transactions to display for the selected period.
                </div>
            `;
            return;
        }
        
        // Create table if it doesn't exist
        let tableHtml = `
            <div class="table-responsive">
                <table id="transactionsTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>File Name</th>
                            <th class="numeric">File Size</th>
                            <th>Ingress Time</th>
                            <th>Egress Time</th>
                            <th class="numeric">Transit Time</th>
                            <th>Status</th>
                            <th class="actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Apply any active filters
        const usernameFilter = document.getElementById('filter_username').value;
        const statusFilter = document.getElementById('filter_status').value;
        
        const filteredTransactions = transactions.filter(tx => {
            if (usernameFilter && tx.username !== usernameFilter) return false;
            if (statusFilter && tx.status !== statusFilter) return false;
            return true;
        });
        
        if (filteredTransactions.length === 0) {
            tableContainer.innerHTML = `
                <div class="no-data-message">
                    <i class="fas fa-filter"></i> No transactions match the selected filters.
                </div>
            `;
            return;
        }
        
        // Generate rows
        filteredTransactions.forEach(tx => {
            const statusClass = tx.status.toLowerCase().replace('_', '-');
            tableHtml += `
                <tr class="status-${statusClass}">
                    <td>${tx.username}</td>
                    <td class="filename">${tx.file_name}</td>
                    <td class="numeric">${formatFileSize(tx.file_size)}</td>
                    <td>${tx.ingress_time_str}</td>
                    <td>${tx.egress_time_str}</td>
                    <td class="numeric">${tx.transit_time}</td>
                    <td>
                        <span class="status-badge ${tx.status.toLowerCase()}">${tx.status}</span>
                    </td>
                    <td class="actions">
                        <button class="copy-btn" 
                                data-transaction='${JSON.stringify(tx).replace(/'/g, "&#39;")}' 
                                title="Copy transaction details">
                            <i class="fas fa-copy"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tableHtml += `
                    </tbody>
                </table>
            </div>
        `;
        
        tableContainer.innerHTML = tableHtml;
        
        // Add event listeners to copy buttons
        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const txData = JSON.parse(this.getAttribute('data-transaction'));
                const textToCopy = Object.entries(txData)
                    .filter(([key]) => !key.includes('_str') && key !== 'transit_time' && typeof txData[key] !== 'object')
                    .map(([key, value]) => `${key}: ${value}`)
                    .join('\n');
                
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        // Visual feedback
                        const originalIcon = this.innerHTML;
                        this.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => { this.innerHTML = originalIcon; }, 1000);
                    })
                    .catch(err => console.error('Copy failed:', err));
            });
        });
    }

    // Function to load username options from API
    function loadUsernames() {
        fetch('/api/usernames')
            .then(response => response.json())
            .then(data => {
                // Update filter dropdown
                const usernameSelect = document.getElementById('filter_username');
                const reportUsernameSelect = document.getElementById('report_username');
                const currentValue = usernameSelect.value;
                
                // Clear existing options except the first "All Usernames" option
                while (usernameSelect.options.length > 1) {
                    usernameSelect.remove(1);
                }
                
                while (reportUsernameSelect.options.length > 1) {
                    reportUsernameSelect.remove(1);
                }
                
                // Add options from API response
                data.usernames.forEach(username => {
                    const option = document.createElement('option');
                    option.value = username;
                    option.textContent = username;
                    usernameSelect.appendChild(option.cloneNode(true));
                    reportUsernameSelect.appendChild(option);
                });
                
                // Restore selected value if it exists in the new options
                if (currentValue) {
                    usernameSelect.value = currentValue;
                }
            })
            .catch(error => {
                console.error('Error loading usernames:', error);
            });
    }

    function showExampleDataBanner(isUsingExampleData) {
        const statusContainer = document.getElementById('db-status-container');
        const statusIndicator = statusContainer.querySelector('.status-indicator');
        const statusText = statusContainer.querySelector('.status-text');
        const statusTime = statusContainer.querySelector('.status-time');
        const detailStatus = document.getElementById('detail-status');
        const detailTime = document.getElementById('detail-time');
        const detailConnection = document.getElementById('detail-connection');
        const detailError = document.getElementById('detail-error');
        const errorContainer = document.getElementById('error-container');
        
        // Get current timestamp with seconds
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        
        // Update the last checked time
        if (statusTime) {
            statusTime.textContent = `Last checked: ${timeString}`;
        }
        
        if (detailTime) {
            detailTime.textContent = timeString;
        }
        
        if (isUsingExampleData) {
            // Disconnected state
            statusIndicator.classList.add('disconnected');
            statusIndicator.classList.remove('connected', 'error');
            statusText.textContent = 'DB Status: Disconnected';
            
            // Update details panel
            if (detailStatus) {
                detailStatus.textContent = 'Disconnected';
                detailStatus.style.color = 'var(--warning-color)';
            }
            
            if (detailConnection) {
                detailConnection.textContent = 'localhost:3306 (MySQL)';
            }
            
            // Show error details with full error message from server logs
            if (errorContainer) {
                errorContainer.style.display = 'flex';
            }
            
            if (detailError) {
                detailError.textContent = "Error 2003 (HY000): Can't connect to MySQL server on 'localhost:3306' (10061)";
            }
            
            // Make clear transactions button disabled in disconnected state
            const dbActionBtn = document.querySelector('.db-action-btn');
            if (dbActionBtn) {
                dbActionBtn.disabled = true;
                dbActionBtn.style.opacity = '0.5';
                dbActionBtn.style.cursor = 'not-allowed';
                dbActionBtn.title = 'Database connection required';
            }
        } else {
            // Connected state
            statusIndicator.classList.add('connected');
            statusIndicator.classList.remove('disconnected', 'error');
            statusText.textContent = 'DB Status: Connected';
            
            // Update details panel
            if (detailStatus) {
                detailStatus.textContent = 'Connected';
                detailStatus.style.color = 'var(--success-color)';
            }
            
            if (detailConnection) {
                detailConnection.textContent = 'localhost:3306 (MySQL)';
            }
            
            // Hide error details
            if (errorContainer) {
                errorContainer.style.display = 'none';
            }
            
            if (detailError) {
                detailError.textContent = 'None';
            }
            
            // Enable clear transactions button in connected state
            const dbActionBtn = document.querySelector('.db-action-btn');
            if (dbActionBtn) {
                dbActionBtn.disabled = false;
                dbActionBtn.style.opacity = '1';
                dbActionBtn.style.cursor = 'pointer';
                dbActionBtn.title = '';
            }
        }
    }

    function refreshDashboard() {
        if (isRefreshing) return;
        isRefreshing = true;
        
        const timeWindow = document.getElementById('time_window').value;
        const numItems = document.getElementById('num_items').value;
        
        // Update the UI to show loading state
        document.getElementById('statsContainer').classList.add('refreshing');
        
        fetch(`/api/dashboard?time_window=${timeWindow}&num_items=${numItems}`)
            .then(response => response.json())
            .then(data => {
                updateStats(data.stats);
                updateTransactionTable(data.transactions);
                showExampleDataBanner(data.using_example_data);
                document.getElementById('statsContainer').classList.remove('refreshing');
                lastRefreshTimestamp = new Date().getTime();
                isRefreshing = false;
                
                // Store transactions for filtering without refetching
                window.currentTransactions = data.transactions;
            })
            .catch(error => {
                console.error('Error refreshing dashboard:', error);
                document.getElementById('statsContainer').classList.remove('refreshing');
                isRefreshing = false;
            });
    }

    // Setup auto-refresh based on user selection
    function setupAutoRefresh() {
        clearInterval(refreshTimer);
        const refreshRate = parseInt(document.getElementById('refresh_rate').value, 10) * 1000;
        if (refreshRate > 0) {
            refreshTimer = setInterval(refreshDashboard, refreshRate);
        }
    }

    // Reports Modal Functions
    function setupReportsModal() {
        // Generate default date range - last 24 hours
        const defaultStartDate = moment().subtract(24, 'hours');
        const defaultEndDate = moment();
        
        // Initialize date range picker
        $('#daterange').daterangepicker({
            startDate: defaultStartDate,
            endDate: defaultEndDate,
            timePicker: true,
            timePicker24Hour: true,
            timePickerIncrement: 15,
            locale: {
                format: 'YYYY-MM-DD HH:mm:ss'
            },
            ranges: {
                'Last 24 Hours': [moment().subtract(24, 'hours'), moment()],
                'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                'This Month': [moment().startOf('month'), moment().endOf('month')],
                'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            }
        });
        
        // Open modal button
        document.getElementById('generateReportBtn').addEventListener('click', function() {
            document.getElementById('reportsModal').style.display = 'flex';
        });
        
        // Close modal buttons
        document.getElementById('closeReportsModal').addEventListener('click', function() {
            document.getElementById('reportsModal').style.display = 'none';
        });
        
        document.getElementById('cancelReportBtn').addEventListener('click', function() {
            document.getElementById('reportsModal').style.display = 'none';
        });
        
        // Download CSV button
        document.getElementById('downloadCsvBtn').addEventListener('click', function() {
            document.getElementById('report_format').value = 'csv';
            document.getElementById('reportForm').submit();
            document.getElementById('reportsModal').style.display = 'none';
        });
        
        // Download HTML button
        document.getElementById('downloadHtmlBtn').addEventListener('click', function() {
            document.getElementById('report_format').value = 'html';
            document.getElementById('reportForm').submit();
            document.getElementById('reportsModal').style.display = 'none';
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                document.getElementById('reportsModal').style.display = 'none';
            }
        });
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Initial load
        refreshDashboard();
        loadUsernames();
        setupReportsModal();
        
        // Setup auto-refresh
        setupAutoRefresh();
        
        // Handle time window changes
        document.getElementById('time_window').addEventListener('change', function() {
            const timeWindow = this.value;
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('time_window', timeWindow);
            window.location.href = currentUrl.toString();
        });
        
        // Handle refresh rate changes
        document.getElementById('refresh_rate').addEventListener('change', setupAutoRefresh);
        
        // Handle filter changes
        document.getElementById('filter_username').addEventListener('change', function() {
            updateTransactionTable(window.currentTransactions || []);
        });
        
        document.getElementById('filter_status').addEventListener('change', function() {
            updateTransactionTable(window.currentTransactions || []);
        });
        
        // Handle num_items changes
        document.getElementById('num_items').addEventListener('change', function() {
            refreshDashboard();
        });
    });
</script>
{% endblock %} 